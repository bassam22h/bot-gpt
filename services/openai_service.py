import re
import logging
from openai import OpenAI
from config import OPENROUTER_API_KEY

# ุฅุนุฏุงุฏ ูุธุงู ุชุณุฌูู ุงูุฃุฎุทุงุก
logging.basicConfig(
    filename='bot_errors.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=OPENROUTER_API_KEY,
)

def clean_text(text):
    """
    ุชูุธูู ุงููุต ูู ุฃู ุฃุญุฑู ุบูุฑ ูุฑุบูุจ ูููุง
    """
    # ุงูุณูุงุญ ุจุงูุฃุญุฑู ุงูุนุฑุจูุฉุ ุงูุฃุฑูุงูุ ุนูุงูุงุช ุงูุชุฑููู ุงูุฃุณุงุณูุฉ ูุงูุฅูููุฌู
    arabic_pattern = r'[\u0600-\u06FF]'
    allowed = r'[#@_ุุ:ุ!ู.ุ \n0-9]'
    emojis = r'[\U0001F600-\U0001F64F\U0001F300-\U0001F5FF]'
    
    clean = re.sub(
        fr'[^{arabic_pattern}{allowed}{emojis}]', 
        '', 
        text
    )
    
    # ุชุญุณูู ุงูุชูุณูู
    clean = re.sub(r'\n+', '\n', clean)  # ูุณุงูุงุช ูุชุนุฏุฏุฉ
    clean = re.sub(r'[ ]+', ' ', clean)  # ุฃุณุทุฑ ูุชุนุฏุฏุฉ
    return clean.strip()

async def generate_post(user_input, platform):
    """
    ุฅูุดุงุก ููุดูุฑ ุงุญุชุฑุงูู ุญุณุจ ุงูููุตุฉ ุงููุญุฏุฏุฉ
    """
    platform_rules = {
        "ุชููุชุฑ": {
            "length": "180-280 ุญุฑูุงู",
            "hashtags": "2-3",
            "max_tokens": 300,
            "examples": [
                "๐ฑ ูุตุงุฆุญ ูุฑูุงุฏุฉ ุงูุฃุนูุงู:\n"
                "- ุงุจุฏุฃ ุตุบูุฑุงู ููุฑ ูุจูุฑุงู\n"
                "- ุงุณุชุซูุฑ ูู ุจูุงุก ุงูุนูุงูุงุช\n"
                "- ุชุนูู ูู ุงูุฃุฎุทุงุก\n"
                "ุงููุฌุงุญ ุฑุญูุฉ ูููุณ ูุฌูุฉ! #ุฑูุงุฏุฉ_ุฃุนูุงู #ุชุทููุฑ_ุฐุงุช"
            ]
        },
        "ููููุฏุฅู": {
            "length": "300-600 ุญุฑูุงู",
            "hashtags": "3-5",
            "max_tokens": 500,
            "examples": [
                "๐ ููู ุชุจูู ุงุณุชุฑุงุชูุฌูุฉ ุชุณููููุฉ ูุงุฌุญุฉุ\n\n"
                "1. ุญุฏุฏ ุฌูููุฑู ุงููุณุชูุฏู ุจุฏูุฉ\n"
                "2. ุฃูุดุฆ ูุญุชูู ุฐู ูููุฉ ุญููููุฉ\n"
                "3. ุงุณุชุฎุฏู ุงูุจูุงูุงุช ูุชุญุณูู ุฃุฏุงุฆู\n\n"
                "ุดุงุฑููุง ุชุฌุฑุจุชู ูู ุงูุชุนูููุงุช! #ุชุณููู_ุฑููู #ุงุณุชุฑุงุชูุฌูุงุช_ุชุณููููุฉ #ููู_ุงูุฃุนูุงู"
            ]
        },
        "ุฅูุณุชุบุฑุงู": {
            "length": "220-400 ุญุฑูุงู",
            "hashtags": "4-5",
            "max_tokens": 400,
            "examples": [
                "โจ ูุตูุฉ ุณููุฉ ูุชุญุถูุฑ ุงููุนู ๐ฐ\n\n"
                "- ููุจ ุทุญูู\n"
                "- ููุนูุฉ ุจูููุฌ ุจุงูุฏุฑ\n"
                "- ูุตู ููุจ ุณูุฑ\n"
                "- ุจูุถุฉ ูุงุญุฏุฉ\n\n"
                "ุงุฎูุท ุงูููููุงุช ุฌูุฏุงู ูุงุฎุจุฒูุง ุนูู 180 ุฏุฑุฌุฉ\n"
                "#ูุตูุงุช #ุญูููุงุช #ูุทุจุฎ #ูุตูุงุช_ุณููุฉ"
            ]
        }
    }

    # ุจูุงุก ุงูุฑุณุงูุฉ ุงููุธุงููุฉ
    system_content = f"""
    ุฃูุช ูุณุงุนุฏ ูุชุงุจุฉ ูุญุชูู ุนุฑุจู ุงุญุชุฑุงูู ูููุงูุน ุงูุชูุงุตู ุงูุงุฌุชูุงุนู.
    ุงููุทููุจ: ูุชุงุจุฉ ููุดูุฑ ูู {platform} ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ููุท ููู ุงูููุงุตูุงุช ุงูุชุงููุฉ:
    
    - ุงูุทูู: {platform_rules[platform]['length']}
    - ุงููููู:
      * ููุฏูุฉ ุฌุฐุงุจุฉ (1-2 ุฌููุฉ)
      * 3 ููุงุท ุฑุฆูุณูุฉ (ูู ููุทุฉ ูู ุณุทุฑ)
      * ุฎุงุชูุฉ ุชุญููุฒูุฉ
    - ุงุณุชุฎุฏู {platform_rules[platform]['hashtags']} ูุงุดุชุงูุงุช ูู ุงูููุงูุฉ
    - ูุณููุญ ุจุงุณุชุฎุฏุงู 2-3 ุฅูููุฌู ููุงุณุจุฉ
    
    ุฃูุซูุฉ ูููุดูุฑุงุช ุฌูุฏุฉ:
    {platform_rules[platform]['examples'][0]}
    
    ุงูููููุนุงุช:
    - ุฃู ูููุงุช ุบูุฑ ุนุฑุจูุฉ
    - ุฑููุฒ ุฃู ุฃุญุฑู ุบุฑูุจุฉ
    - ูุญุชูู ุบูุฑ ููุธู
    
    ุงููุญุชูู ุงููุทููุจ:
    """

    try:
        response = client.chat.completions.create(
            model="deepseek/deepseek-v3-base:free",
            messages=[
                {"role": "system", "content": system_content},
                {"role": "user", "content": user_input}
            ],
            temperature=0.7,
            max_tokens=platform_rules[platform]['max_tokens']
        )
        
        result = response.choices[0].message.content
        cleaned_result = clean_text(result)
        
        # ุชุณุฌูู ุงููุฌุงุญ
        logging.info(f"ุชู ุฅูุดุงุก ููุดูุฑ ูู {platform}: {cleaned_result[:50]}...")
        return cleaned_result
        
    except Exception as e:
        logging.error(f"Error in generate_post: {str(e)}")
        return f"โ๏ธ ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูููุดูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.\n{str(e)}"
